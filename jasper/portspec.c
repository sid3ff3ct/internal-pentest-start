#include "portspec.h"

struct port_generator *parse_ports(char *spec) {
  char *current;
  char *cursor;
  char *hyphen;
  int len;
  struct port_generator *gen;
  struct port_spec *range;
                
  gen = (struct port_generator *)calloc(1, sizeof(struct port_generator));
  len = strlen(spec) + 1;
        
  for(current = cursor = spec, hyphen = NULL; cursor < spec + len; cursor++) {
    switch(*cursor) {
    case ',':
    case '\0':
      range        = (struct port_spec*)malloc(sizeof(struct port_spec));
      range->start = atoi(current);
      range->end   = hyphen ? atoi(hyphen+1) : range->start;
      gen->ports   = push((void *)range, gen->ports);
      current      = cursor + 1;
      hyphen       = NULL;
      break;
    case '-':
      hyphen = cursor;
    }
  }
  return gen;
}

unsigned short next_port(struct port_generator *gen) {
  struct port_spec *ptr;
  struct node *n;
  int retval = 0;
        
  if(gen->ports) {
    ptr = (struct port_spec *) gen->ports->object;
    if(ptr->start == ptr->end) {
      retval     = ptr->start;
      n          = gen->ports;
      gen->ports = gen->ports->next;
      free(ptr);
      free(n);
    } else {
      retval = ptr->start++;
    }
  }
        
  return retval;
}

int count_ports(struct port_generator *gen) {
  struct node *ptr;
  struct port_spec *spec;
  int count = 0;
        
  if(gen) {
    for(ptr = gen->ports; ptr; ptr = ptr->next) {
      spec = (struct port_spec *) ptr->object;
      count += spec->end - spec->start + 1;
    }
  }
        
  return count;
}
