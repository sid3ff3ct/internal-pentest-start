//
// backend.c -- this defines the essential functions to support a multi-
// threaded port scanner.  This implements a full TCP connect scan, with
// a hard-coded timeout. 
//
// Author:  Josh Stone
// Contact: yakovdk@gmail.com
//

#include "backend.h"

void scanner_init() {
  WSADATA wsaData;
  int ret;

  printf("  [-] WinSock Startup...");
  ret = WSAStartup(MAKEWORD(2, 1), &wsaData);
  if (ret < 0) {
    WSACleanup();
    printf(" error.\n");
    exit(1);
  }
  printf("done.\n");
}

void * config_scan(char *target, int port) {
  struct scan_result *a;
  int len;
  len = strlen(target);
  a = (struct scan_result *)malloc(sizeof(struct scan_result));
  a->target = (char *)malloc(len + 1);
  strncpy(a->target, target, strlen(target));
  a->target[len] = '\0';
  a->done = 0;
  a->result = 0;
  a->port = port;
  return a;
}

int free_scan(struct scan_result *record) {
  int ret;
  ret = record-> result;
  free(record->target);
  free(record);
  return ret;
}  

void run_scan_thread(struct scan_result *record) {
  record->result = port_scan(record->target, record->port, 1);
  record->done = 1;
}

void launch_scan(struct scan_result *record) {
  CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)run_scan_thread, record, 0, NULL);
}

//
// Scan a given host and port combination with a relatively short
// timeout.  The timeout is important because you probably don't want
// to wait for 30 seconds to find out if a port is filtered.
//

int port_scan(char *host, int port, int retry) {
  struct hostent *target;
  struct sockaddr_in addr;
  fd_set fdwrite, fderr;
  SOCKET sock;
  int value;
  unsigned long NonBlk = 1;
  TIMEVAL timeout;
  int ret = 0;

  sock = socket(AF_INET, SOCK_STREAM, 0);
  ioctlsocket(sock, FIONBIO, &NonBlk);

  target = gethostbyname(host);
  if (target == NULL) {
    return 0;
  }
  memcpy(&addr.sin_addr.s_addr, target->h_addr, target->h_length);
  addr.sin_family = AF_INET;
  addr.sin_port = htons(port);

  value = connect(sock, (struct sockaddr*)&addr, sizeof(addr));

  FD_ZERO(&fdwrite);
  FD_ZERO(&fderr);
  FD_SET(sock, &fdwrite);
  FD_SET(sock, &fderr);
  timeout.tv_sec = 0;
  timeout.tv_usec = TIMEOUT;

  value = select(0, NULL, &fdwrite, &fderr, &timeout);

  ret = value && FD_ISSET(sock, &fdwrite);
  closesocket(sock);

  if(!ret && retry > 0) {
    Sleep(100);
    port_scan(host, port, retry - 1);
  }
  
  return ret;
}
