#include <winsock2.h>
#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <getopt.h>

#include "backend.h"
#include "list.h"
#include "portspec.h"
#include "cmdline.h"

void launch(struct node *list) {
  struct scan_result *obj;
  for(; list != NULL; list = list->next) {
    obj = (struct scan_result *)list->object;
    launch_scan(obj);
  }
}

int all_completed(struct node *list) {
  struct node *cursor;
  struct scan_result *obj;
  for(cursor = list; cursor != NULL; cursor = cursor->next) {
    obj = (struct scan_result *)cursor->object;
    if(!obj->done) {
      return 0;
    }
  }
  return 1;
}

void print_results(struct node *list) {
  struct node *cursor;
  struct scan_result *obj;
  
  for(cursor = list; cursor != NULL; cursor = cursor->next) {
    obj = (struct scan_result *)cursor->object;
    if(obj->result) {
      printf("  [+] Result: %15s %5d OPEN\n", obj->target, obj->port);
    }
  }
  
  for(cursor = list; cursor; ) {
    cursor = cursor->next;
    free(list->object);
    free(list);
    list = cursor;
  }
}

void do_scan(struct node *root) {
  launch(root);
  while(TRUE) {
    if(all_completed(root)) {
      print_results(root);
      return;
    }
    Sleep(50);
  }
}

void usage() {
  printf("\n  usage: jasper.exe -p <ports> [-f <file>] [-t <num>] [<host> ...]\n\n");
  printf("    -p <ports>    Ports to scan (comma-delimited list of ports / ranges)\n");
  printf("    -f <file>     Read target hosts, one per line, from indicated file\n");
  printf("    -t <num>      Specify number of concurrent threads (default: 16)\n");
  printf("\n");
  printf("  Example:\n");
  printf("\n");
  printf("    jasper -p 22,80,8000-8010,443 -f hosts.txt -t 12 10.10.10.1\n");
  printf("\n");
  exit(1);
}

int main(int argc, char **argv) {
  int            count   = 0;
  struct node   *root    = NULL;
  struct node   *cursor  = NULL;
  struct config *cfg     = NULL;
  unsigned short port    = 0;
  
  int totalports         = 0;
  int totaltargets       = 0;

  printf("\n------------------------------------------------------------------------\n");
  printf("        Josh's Actually Small Port ScannER -- yakovdk@gmail.com\n");
  printf("------------------------------------------------------------------------\n\n");

  cfg = parse_cmdline(argc, argv);
  
  if(cfg->targets == NULL) {
    printf("  [!] ERROR: no targets specified\n");
    usage();
  } else if(cfg->port_gen == NULL) {
    printf("  [!] ERROR: no ports specified\n");
    usage();
  }
  
  scanner_init();

  totalports   = count_ports(cfg->port_gen);
  totaltargets = list_length(cfg->targets);
  
  printf("  [-] Loaded %d target(s)\n",                totaltargets);
  printf("  [-] Loaded %d port specifier(s)\n",        list_length(cfg->port_gen->ports));
  printf("  [-] Loaded %d individual port(s)\n",       totalports);
  printf("  [-] Total %d work unit(s) (host-ports)\n", totalports * totaltargets);
  
  while((port = next_port(cfg->port_gen))) {
    for(cursor = cfg->targets; cursor != NULL; cursor = cursor->next) {
      root = push(config_scan((char *)cursor->object, port), root);
      count++;
      if(count % cfg->threads == 0) {
        do_scan(root);
        root = NULL;
      }
    }
  }
  do_scan(root);

  return 0;
}
