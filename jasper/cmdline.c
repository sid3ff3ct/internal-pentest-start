#include "cmdline.h"

struct node *read_targets(char *file) {
  FILE *f;
  char *line;
  size_t len;
  struct node *lst = NULL;
  char buffer[1024];
        
  f = fopen(file, "r");
  if(!f) {
    printf("Error opening file '%s'\n", file);
    exit(1);
  }

  while(fgets(buffer, sizeof(buffer), f)) {
    len  = strlen(buffer);
    line = (char *)malloc(len + 1);
    strncpy(line, buffer, len + 1);
    if(line[len - 1] == '\n') line[len - 1] = '\0';
    lst = push(line, lst);
  }
        
  return lst;
}

struct config *parse_cmdline(int argc, char **argv) {
  int c = 0;
  struct config *cfg;
  int i;
  int gensize = sizeof(struct port_generator);
        
  cfg = (struct config *)malloc(sizeof(struct config));
  cfg->targets = NULL;
  cfg->port_gen = NULL;
  cfg->threads = 16;
        
  while((c = getopt(argc, argv, "p:f:t:")) != -1)       {
    switch (c) {
    case 'p':
      cfg->port_gen = (struct port_generator *) malloc(gensize);
      cfg->port_gen = parse_ports(optarg);
      break;
    case 'f':
      cfg->targets = read_targets(optarg);
      break;
    case 't':
      cfg->threads = atoi(optarg);
      break;
    default:
      printf("Unknown switch '%c'\n", c);
    }
  }
        
  for(i = optind; i < argc; i++) {
    cfg->targets = push((void *)argv[i], cfg->targets);
  }
        
  return cfg;
}
